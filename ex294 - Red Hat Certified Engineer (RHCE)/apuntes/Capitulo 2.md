# Tema 2 - Deploying Ansible

- Building an Ansible Inventory
- Managing Ansible Configuration Files
- Running Ad Hoc Commands

## Building an Ansible Inventory

- Hay inventarios estáticos (un archivo) y dinámicos (un script que devuelve el inventario).
- Los estáticos suelen ser en formato _ini_ o YAML.
- Pueden definirse grupos de hosts.
- Siempre habrá dos grupos predefinidos: `all` y `ungrouped` (los hosts que no tienen grupo).

Grupos anidados:

```ini

[spain]
server01.spain.es

[portugal]
server01.portugal.pt

[europe:children]
spain
portugal
```

Para verificar un inventario puede usarse `ansible-inventory`.

```bash
ansible -i <inventario> --list-hosts
ansible-inventory -i <inventario> --list
ansible-inventory -i <inventario> --graph
ansible-inventory -i <inventario> --graph --vars
```

Hay un inventario por defecto en `/etc/ansible/inventory` pero lo normal es utilizar un fichero en otra ubicación.


## Ansible configuration file

El archivo de configuración se busca en las siguientes rutas, ordenadas por preferencia:

1. Variable de entorno `ANSIBLE_CONFIG`.
2. `./ansible.cfg`.
3. `~/.ansible.cfg`.
4. `/etc/ansible/ansible.cfg`.

A la hora de buscar un valor de configuración éste será buscado en cascada entre todos los ficheros previamente mencionado. Algunos valores pueden redefinirse en variables dentro de _playbooks_, _plays_, etc.

El comando `ansible --version` especifica el fichero que se está usando.

```bash
hector@red-queen:~/repos/ansible-playbooks$ ansible --version

ansible 2.9.7
  config file = /home/hector/repos/ansible-playbooks/ansible.cfg
  configured module search path = ['/home/hector/repos/ansible-playbooks/plugins/modules']
  ansible python module location = /home/hector/.local/lib/python3.8/site-packages/ansible
  executable location = /home/hector/.local/bin/ansible
  python version = 3.8.2 (default, Apr 27 2020, 15:53:34) [GCC 9.3.0]
```
## Comandos ad-hoc

Para comandos _ad-hoc_ se usa el comando `ansible`:

```bash
ansible -m _modulo_ [-a _'argumentos del módulo'_] [-i _'inventario'_]
```

Para ver los módulos instalados:

```bash
ansible-doc -l
```

Para ver documentación de un módulo desde CLI:

```bash
ansible-doc [-t _'tipo de documentacion'_] _dato a buscar_
```

## Command vs shell vs raw

Todos ejecutan un comando remoto con las siguientes consideraciones:

- `command`: Requiere Python. No interpreta parámetros especiales de _shell_, como _pipes_ o redirecciones.
- `shell`: Requiere python. Interpreta parámetros especiales de _shell_.
- `raw`: como _shell_ pero no requiere Python.

Se desaconseja usar cualquiera de los tres y se recomienda usar los módulos correspondientes.

# Preguntas

- ¿En los exámenes es necesario gestionar las suscripciones de Ansible? -> no

# Mans importantes

- man:ansible
- man:ansible-config
- man:ansible-inventory

# Enlaces interesantes

- http://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html
- https://docs.ansible.com/ansible/latest/installation_guide/intro_configuration.html
- https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html
- http://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html
- http://docs.ansible.com/ansible/latest/modules/modules_by_category
- http://docs.ansible.com/ansible/latest/modules/command_module.html
- http://docs.ansible.com/ansible/latest/modules/shell_module.html

# Sumario

- Any system upon which Ansible is installed and which has access to the required configuration files and playbooks to manage remote systems (managed hosts) is called a control node.
- Managed hosts are defined in the inventory. Host patterns are used to reference managed hosts defined in an inventory.
- Inventories can be static files or dynamically generated by a program from an external source, such as a directory service or cloud management system.
- Ansible looks for its configuration file in a number of places in order of precedence. The first configuration file found is used; all others are ignored.
- The ansible command is used to perform ad hoc commands on managed hosts.
- Ad hoc commands determine the operation to perform through the use of modules and their arguments, and can make use of Ansible's privilege escalation features.
